using FlaUI.Core;
using FluentAssertions;
using FluentPDF.App.Tests.PageObjects;

namespace FluentPDF.App.Tests.E2E;

/// <summary>
/// End-to-end tests for file opening workflow using FlaUI.
/// Validates that users can successfully open PDF files through the UI.
/// </summary>
[Trait("Category", "E2E")]
public class FileOpenTests : FlaUITestBase
{
    private const string SamplePdfPath = "../../../../Fixtures/simple-text.pdf";

    /// <summary>
    /// Tests that a PDF file can be opened and displays correctly.
    /// </summary>
    [Fact(Skip = "E2E test requires built application - run manually on Windows")]
    public void OpenPdfFile_ShouldDisplayDocument()
    {
        // Arrange
        var fullPdfPath = Path.GetFullPath(Path.Combine(AppContext.BaseDirectory, SamplePdfPath));
        if (!File.Exists(fullPdfPath))
        {
            throw new FileNotFoundException($"Sample PDF not found at {fullPdfPath}");
        }

        Window? mainWindow = null;

        try
        {
            // Act: Launch the application
            mainWindow = LaunchApp(waitTimeoutMs: 10000);

            // Assert: Main window should be displayed
            mainWindow.Should().NotBeNull("main window should launch");
            mainWindow.Title.Should().Be("FluentPDF", "main window should have correct title");

            // Act: Open the PDF file
            var mainWindowPage = new MainWindowPage(mainWindow);
            mainWindowPage.OpenFile(fullPdfPath);

            // Give the app time to load the PDF
            Wait.UntilInputIsProcessed(TimeSpan.FromSeconds(2));

            // Assert: PDF should be loaded
            var isPdfLoaded = mainWindowPage.IsPdfLoaded();
            isPdfLoaded.Should().BeTrue("PDF file should be loaded and displayed");

            // Capture screenshot for visual verification
            var screenshotPath = CaptureScreenshot(mainWindow, "FileOpenTests_Success");
            Console.WriteLine($"Screenshot saved: {screenshotPath}");
        }
        catch (Exception ex)
        {
            // Capture screenshot on failure
            if (mainWindow != null)
            {
                CaptureScreenshotOnFailure(mainWindow, "FileOpenTests_OpenPdfFile", ex);
            }
            throw;
        }
        finally
        {
            // Cleanup: Close the application
            CloseApp();
        }
    }

    /// <summary>
    /// Tests that opening a non-existent file is handled gracefully.
    /// </summary>
    [Fact(Skip = "E2E test requires built application - run manually on Windows")]
    public void OpenNonExistentFile_ShouldHandleGracefully()
    {
        // Arrange
        var nonExistentPath = Path.Combine(Path.GetTempPath(), "non-existent-file.pdf");

        Window? mainWindow = null;

        try
        {
            // Act: Launch the application
            mainWindow = LaunchApp(waitTimeoutMs: 10000);

            // Assert: Main window should be displayed
            mainWindow.Should().NotBeNull("main window should launch");

            // Act: Attempt to open non-existent file
            var mainWindowPage = new MainWindowPage(mainWindow);
            Action openAction = () => mainWindowPage.OpenFile(nonExistentPath);

            // Assert: Should throw FileNotFoundException
            openAction.Should().Throw<FileNotFoundException>(
                "opening a non-existent file should throw FileNotFoundException");
        }
        catch (Exception ex)
        {
            // Capture screenshot on failure
            if (mainWindow != null)
            {
                CaptureScreenshotOnFailure(mainWindow, "FileOpenTests_NonExistentFile", ex);
            }
            throw;
        }
        finally
        {
            // Cleanup: Close the application
            CloseApp();
        }
    }

    /// <summary>
    /// Tests that the application launches successfully without errors.
    /// </summary>
    [Fact(Skip = "E2E test requires built application - run manually on Windows")]
    public void LaunchApplication_ShouldSucceed()
    {
        Window? mainWindow = null;

        try
        {
            // Act: Launch the application
            mainWindow = LaunchApp(waitTimeoutMs: 10000);

            // Assert: Main window should be displayed
            mainWindow.Should().NotBeNull("main window should launch successfully");
            mainWindow.Title.Should().Be("FluentPDF", "window should have correct title");

            // Verify the window is responsive
            var mainWindowPage = new MainWindowPage(mainWindow);
            var windowTitle = mainWindowPage.GetWindowTitle();
            windowTitle.Should().Be("FluentPDF", "window title should be accessible");
        }
        catch (Exception ex)
        {
            // Capture screenshot on failure
            if (mainWindow != null)
            {
                CaptureScreenshotOnFailure(mainWindow, "FileOpenTests_LaunchApp", ex);
            }
            throw;
        }
        finally
        {
            // Cleanup: Close the application
            CloseApp();
        }
    }
}
