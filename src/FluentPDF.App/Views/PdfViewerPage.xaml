<?xml version="1.0" encoding="UTF-8" ?>
<Page
    x:Class="FluentPDF.App.Views.PdfViewerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:FluentPDF.App.Views"
    xmlns:converters="using:FluentPDF.App.Converters"
    xmlns:controls="using:FluentPDF.App.Controls"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    x:Name="RootPage">

    <Page.Resources>
        <!-- Value Converters -->
        <converters:PercentageConverter x:Key="PercentageConverter" />
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <converters:InverseNullToVisibilityConverter x:Key="InverseNullToVisibilityConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:MatchCounterConverter x:Key="MatchCounterConverter" />
    </Page.Resources>

    <Page.KeyboardAccelerators>
        <KeyboardAccelerator Key="F" Modifiers="Control" Invoked="OnSearchKeyboardAccelerator" />
    </Page.KeyboardAccelerators>

    <SplitView
        IsPaneOpen="{x:Bind ViewModel.BookmarksViewModel.IsPanelVisible, Mode=TwoWay}"
        OpenPaneLength="{x:Bind ViewModel.BookmarksViewModel.PanelWidth, Mode=TwoWay}"
        DisplayMode="Inline"
        PaneBackground="{ThemeResource LayerFillColorDefaultBrush}">

        <!-- Left Pane: Bookmarks Panel -->
        <SplitView.Pane>
            <controls:BookmarksPanel/>
        </SplitView.Pane>

        <!-- Main Content -->
        <SplitView.Content>
            <Grid>
                <Grid.RowDefinitions>
                    <!-- Toolbar row -->
                    <RowDefinition Height="Auto" />
                    <!-- Search panel row -->
                    <RowDefinition Height="Auto" />
                    <!-- Progress bar row -->
                    <RowDefinition Height="Auto" />
                    <!-- Content row -->
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Toolbar -->
                <CommandBar Grid.Row="0" DefaultLabelPosition="Right">
            <!-- Open File -->
            <AppBarButton
                Icon="OpenFile"
                Label="Open"
                Command="{x:Bind ViewModel.OpenDocumentCommand, Mode=OneWay}">
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="O" Modifiers="Control" />
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>

            <AppBarSeparator />

            <!-- Navigation Controls -->
            <AppBarButton
                Icon="Previous"
                Label="Previous"
                Command="{x:Bind ViewModel.GoToPreviousPageCommand, Mode=OneWay}">
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="Left" />
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>

            <AppBarElementContainer>
                <TextBlock
                    VerticalAlignment="Center"
                    Margin="12,0"
                    FontWeight="SemiBold">
                    <Run Text="Page " />
                    <Run Text="{x:Bind ViewModel.CurrentPageNumber, Mode=OneWay}" />
                    <Run Text=" of " />
                    <Run Text="{x:Bind ViewModel.TotalPages, Mode=OneWay}" />
                </TextBlock>
            </AppBarElementContainer>

            <AppBarButton
                Icon="Next"
                Label="Next"
                Command="{x:Bind ViewModel.GoToNextPageCommand, Mode=OneWay}">
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="Right" />
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>

            <AppBarSeparator />

            <!-- Toggle Bookmarks -->
            <AppBarButton
                Icon="AlignLeft"
                Label="Bookmarks"
                Command="{x:Bind ViewModel.BookmarksViewModel.TogglePanelCommand, Mode=OneWay}">
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="B" Modifiers="Control" />
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>

            <!-- Toggle Search -->
            <AppBarButton
                Icon="Find"
                Label="Search"
                Command="{x:Bind ViewModel.ToggleSearchPanelCommand, Mode=OneWay}">
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="F" Modifiers="Control" />
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>

            <AppBarSeparator />

            <!-- Zoom Controls -->
            <AppBarButton
                Label="Zoom Out"
                Command="{x:Bind ViewModel.ZoomOutCommand, Mode=OneWay}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE71F;" />
                </AppBarButton.Icon>
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="Subtract" Modifiers="Control" />
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>

            <AppBarElementContainer>
                <TextBlock
                    Text="{x:Bind ViewModel.ZoomLevel, Mode=OneWay, Converter={StaticResource PercentageConverter}}"
                    VerticalAlignment="Center"
                    Margin="12,0"
                    FontWeight="SemiBold"
                    MinWidth="50"
                    TextAlignment="Center" />
            </AppBarElementContainer>

            <AppBarButton
                Label="Zoom In"
                Command="{x:Bind ViewModel.ZoomInCommand, Mode=OneWay}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE71E;" />
                </AppBarButton.Icon>
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="Add" Modifiers="Control" />
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>

            <AppBarButton
                Label="Reset Zoom"
                Command="{x:Bind ViewModel.ResetZoomCommand, Mode=OneWay}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE8A0;" />
                </AppBarButton.Icon>
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="Number0" Modifiers="Control" />
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>

            <AppBarSeparator />

            <!-- Document Editing Operations -->
            <AppBarButton
                Label="Merge"
                Command="{x:Bind ViewModel.MergeDocumentsCommand, Mode=OneWay}"
                ToolTipService.ToolTip="Merge multiple PDF files">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE8F4;" />
                </AppBarButton.Icon>
            </AppBarButton>

            <AppBarButton
                Label="Split"
                Command="{x:Bind ViewModel.SplitDocumentCommand, Mode=OneWay}"
                ToolTipService.ToolTip="Split PDF by page ranges">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE8F5;" />
                </AppBarButton.Icon>
            </AppBarButton>

            <AppBarButton
                Label="Optimize"
                Command="{x:Bind ViewModel.OptimizeDocumentCommand, Mode=OneWay}"
                ToolTipService.ToolTip="Optimize PDF to reduce file size">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE74E;" />
                </AppBarButton.Icon>
            </AppBarButton>

            <AppBarSeparator />

            <!-- DOCX Conversion -->
            <AppBarButton
                Label="Convert DOCX"
                Click="OnConvertDocxClick"
                ToolTipService.ToolTip="Convert DOCX files to PDF">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE8B7;" />
                </AppBarButton.Icon>
                <AppBarButton.KeyboardAccelerators>
                    <KeyboardAccelerator Key="C" Modifiers="Control,Shift" />
                </AppBarButton.KeyboardAccelerators>
            </AppBarButton>
        </CommandBar>

        <!-- Search Panel -->
        <Grid
            Grid.Row="1"
            Padding="12,8"
            Background="{ThemeResource LayerFillColorDefaultBrush}"
            Visibility="{x:Bind ViewModel.IsSearchPanelVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Search TextBox -->
            <TextBox
                x:Name="SearchTextBox"
                Grid.Column="0"
                PlaceholderText="Search..."
                Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                Width="300"
                VerticalAlignment="Center"
                Margin="0,0,8,0">
                <TextBox.KeyboardAccelerators>
                    <KeyboardAccelerator Key="Escape" Invoked="OnSearchEscapePressed" />
                </TextBox.KeyboardAccelerators>
            </TextBox>

            <!-- Match Counter -->
            <TextBlock
                Grid.Column="1"
                VerticalAlignment="Center"
                Margin="8,0"
                Style="{StaticResource BodyTextBlockStyle}">
                <Run Text="{x:Bind ViewModel.CurrentMatchIndex, Mode=OneWay, Converter={StaticResource MatchCounterConverter}}" />
                <Run Text=" of " />
                <Run Text="{x:Bind ViewModel.SearchMatches.Count, Mode=OneWay}" />
            </TextBlock>

            <!-- Navigation Buttons -->
            <StackPanel
                Grid.Column="2"
                Orientation="Horizontal"
                Spacing="4"
                Margin="8,0">
                <Button
                    Content="Previous"
                    Command="{x:Bind ViewModel.GoToPreviousMatchCommand, Mode=OneWay}"
                    ToolTipService.ToolTip="Previous match (Shift+F3)"
                    Style="{StaticResource AccentButtonStyle}"
                    MinWidth="90">
                    <Button.KeyboardAccelerators>
                        <KeyboardAccelerator Key="F3" Modifiers="Shift" />
                    </Button.KeyboardAccelerators>
                </Button>
                <Button
                    Content="Next"
                    Command="{x:Bind ViewModel.GoToNextMatchCommand, Mode=OneWay}"
                    ToolTipService.ToolTip="Next match (F3)"
                    Style="{StaticResource AccentButtonStyle}"
                    MinWidth="90">
                    <Button.KeyboardAccelerators>
                        <KeyboardAccelerator Key="F3" />
                    </Button.KeyboardAccelerators>
                </Button>
            </StackPanel>

            <!-- Case Sensitive Checkbox -->
            <CheckBox
                Grid.Column="3"
                Content="Case sensitive"
                IsChecked="{x:Bind ViewModel.CaseSensitive, Mode=TwoWay}"
                VerticalAlignment="Center"
                Margin="8,0" />

            <!-- Close Button -->
            <Button
                Grid.Column="4"
                Content="&#xE711;"
                FontFamily="Segoe MDL2 Assets"
                Command="{x:Bind ViewModel.ToggleSearchPanelCommand, Mode=OneWay}"
                ToolTipService.ToolTip="Close search (Escape)"
                Style="{StaticResource SubtleButtonStyle}"
                Width="32"
                Height="32"
                Margin="8,0,0,0" />

            <!-- Search Progress Indicator -->
            <ProgressRing
                Grid.Column="0"
                Grid.ColumnSpan="5"
                IsActive="{x:Bind ViewModel.IsSearching, Mode=OneWay}"
                Width="24"
                Height="24"
                HorizontalAlignment="Right"
                VerticalAlignment="Center"
                Margin="0,0,48,0" />
        </Grid>

        <!-- Progress Bar and Cancel Button -->
        <Grid
            Grid.Row="2"
            Padding="12,8"
            Background="{ThemeResource LayerFillColorDefaultBrush}"
            Visibility="{x:Bind ViewModel.IsOperationInProgress, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Spacing="4">
                <TextBlock
                    Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                    Style="{StaticResource BodyTextBlockStyle}" />
                <ProgressBar
                    Value="{x:Bind ViewModel.OperationProgress, Mode=OneWay}"
                    Maximum="100"
                    IsIndeterminate="False"
                    ShowError="False"
                    ShowPaused="False" />
            </StackPanel>

            <Button
                Grid.Column="1"
                Content="Cancel"
                Command="{x:Bind ViewModel.CancelOperationCommand, Mode=OneWay}"
                VerticalAlignment="Center"
                Margin="12,0,0,0" />
        </Grid>

        <!-- Content Area -->
        <Grid Grid.Row="3">
            <Grid.RowDefinitions>
                <!-- InfoBar for validation errors -->
                <RowDefinition Height="Auto" />
                <!-- PDF content area -->
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Validation error panel -->
            <controls:ValidationErrorPanel
                Grid.Row="0"
                x:Name="ValidationPanel"
                IsOpen="{x:Bind ViewModel.FormFieldViewModel.HasValidationErrors, Mode=OneWay}"
                SummaryMessage="{x:Bind ViewModel.FormFieldViewModel.ValidationMessage, Mode=OneWay}"
                ValidationErrors="{x:Bind ViewModel.FormFieldViewModel.ValidationErrors, Mode=OneWay}"
                GoToFieldRequested="OnGoToFieldRequested" />

            <!-- Page viewer with scrolling and form field overlays -->
            <ScrollViewer
                Grid.Row="1"
                x:Name="PdfScrollViewer"
                HorizontalScrollBarVisibility="Auto"
                VerticalScrollBarVisibility="Auto"
                Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
                ViewChanged="OnScrollViewerViewChanged">
                <Grid>
                    <!-- PDF page image -->
                    <Image
                        x:Name="PdfPageImage"
                        Source="{x:Bind ViewModel.CurrentPageImage, Mode=OneWay}"
                        Visibility="{x:Bind ViewModel.CurrentPageImage, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"
                        Stretch="None"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center" />

                    <!-- Form field overlays canvas -->
                    <Canvas
                        x:Name="FormFieldCanvas"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Visibility="{x:Bind ViewModel.FormFieldViewModel.HasFormFields, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.FormFieldViewModel.FormFields, Mode=OneWay}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <Canvas />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <controls:FormFieldControl
                                        Field="{Binding}"
                                        ZoomLevel="{Binding ElementName=RootPage, Path=ViewModel.ZoomLevel}"
                                        IsInErrorState="False" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Canvas>
                </Grid>
            </ScrollViewer>

            <!-- Loading indicator -->
            <ProgressRing
                Grid.Row="1"
                IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                Width="60"
                Height="60"
                HorizontalAlignment="Center"
                VerticalAlignment="Center" />

            <!-- Empty state message -->
            <TextBlock
                Grid.Row="1"
                Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Visibility="{x:Bind ViewModel.CurrentPageImage, Mode=OneWay, Converter={StaticResource InverseNullToVisibilityConverter}}"
                Style="{StaticResource SubtitleTextBlockStyle}"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                </Grid>
            </Grid>
        </SplitView.Content>
    </SplitView>
</Page>
