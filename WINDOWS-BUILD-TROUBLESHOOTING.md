# Windows Build Troubleshooting Guide

This guide helps diagnose and resolve WinUI 3 XAML compiler issues when building FluentPDF.App on Windows.

## Quick Diagnostics

### Step 1: Validate XAML Files

Before building, validate XAML files for common issues:

```powershell
.\validate-xaml-windows.ps1 -Verbose
```

This checks for:
- Missing code-behind files
- Non-existent converter/ViewModel references
- Namespace declaration errors
- Duplicate x:Name attributes
- Common typos

### Step 2: Run Diagnostic Build

If validation passes, run the diagnostic build script:

```powershell
.\build-diagnostics-windows.ps1 -Clean
```

This will:
- Display your build environment details
- Clean previous build artifacts
- Build with maximum verbosity
- Generate detailed log files
- Provide guidance for analyzing failures

## Common XAML Compiler Issues

### Issue 1: XamlCompiler.exe Exit Code 1 (MSB3073)

**Symptom**: Build fails with error MSB3073, XamlCompiler.exe exits with code 1, no diagnostic output

**Known Cause**: This is a [documented bug in WinUI 3](https://github.com/microsoft/microsoft-ui-xaml/issues/9813) where XamlCompiler.exe fails silently without logging error details.

**Troubleshooting Steps**:

1. **Check Windows SDK Installation**
   ```powershell
   # Verify Windows SDK is installed
   Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows Kits\Installed Roots" | Select-Object KitsRoot10

   # Expected: C:\Program Files (x86)\Windows Kits\10\
   ```

2. **Clear NuGet Package Cache**
   ```powershell
   dotnet nuget locals all --clear
   dotnet restore src\FluentPDF.App\FluentPDF.App.csproj
   ```

3. **Analyze Build Logs**
   ```powershell
   # After running build-diagnostics-windows.ps1, search for errors:
   Select-String -Path build-diagnostics-*.log -Pattern 'XamlCompiler' -Context 5,5
   Select-String -Path build-diagnostics-*.log -Pattern 'error|Error|ERROR' | Select-Object -First 20
   ```

4. **Check XAML Files**
   - Verify all .xaml files have corresponding .xaml.cs code-behind files
   - Check for typos in namespace declarations
   - Validate x:Name attributes are unique
   - Look for invalid x:Bind expressions

5. **Verify Converter Classes**
   ```powershell
   # All converters should be in this directory:
   Get-ChildItem src\FluentPDF.App\Converters\*.cs
   ```

6. **Check for Circular Dependencies**
   - Review ResourceDictionary merges in App.xaml
   - Check for circular references in XAML files

### Issue 2: Platform Mismatch

**Symptom**: Build fails with "Platform x86/x64/ARM64 not found" errors

**Solution**: Always specify platform explicitly:

```powershell
dotnet build src\FluentPDF.App\FluentPDF.App.csproj -p:Platform=x64
dotnet test tests\FluentPDF.App.Tests -p:Platform=x64
```

### Issue 3: Missing Dependencies

**Symptom**: Build fails with missing assembly references

**Solution**: Build dependencies in order:

```powershell
# 1. Build Core (cross-platform, no platform needed)
dotnet build src\FluentPDF.Core

# 2. Build Rendering (cross-platform, no platform needed)
dotnet build src\FluentPDF.Rendering

# 3. Build App (Windows-only, requires platform)
dotnet build src\FluentPDF.App -p:Platform=x64
```

## Manual Build Steps (Alternative to Script)

If the diagnostic script doesn't work, try these manual steps:

```powershell
# Step 1: Clean everything
dotnet clean src\FluentPDF.App\FluentPDF.App.csproj -p:Platform=x64
Remove-Item -Recurse -Force src\FluentPDF.App\obj, src\FluentPDF.App\bin -ErrorAction SilentlyContinue

# Step 2: Restore packages
dotnet restore src\FluentPDF.App\FluentPDF.App.csproj

# Step 3: Build with diagnostic logging
dotnet build src\FluentPDF.App\FluentPDF.App.csproj `
    -p:Platform=x64 `
    -v:diag `
    -fl `
    -flp:"logfile=manual-build.log;verbosity=diagnostic"
```

## Environment Requirements

### Minimum Requirements
- Windows 10 version 1809 (build 17763) or later
- .NET 8 SDK
- Windows SDK 10.0.19041.0 or later
- Visual Studio 2022 (recommended) or VS Build Tools

### Verify .NET SDK
```powershell
dotnet --version
# Expected: 8.x.x
```

### Verify Windows SDK
```powershell
Get-ItemProperty "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Microsoft SDKs\Windows\v10.0" | Select-Object ProductVersion, InstallationFolder
```

## Getting Help

If issues persist:

1. Review the diagnostic log file generated by `build-diagnostics-windows.ps1`
2. Check for known issues:
   - [WinUI 3 GitHub Issues](https://github.com/microsoft/microsoft-ui-xaml/issues)
   - [Windows App SDK Issues](https://github.com/microsoft/WindowsAppSDK/issues)
3. Search for specific error codes in the log files
4. Ensure all source files are synced correctly from the Linux development machine

## Related Issues

- [XamlCompiler.exe needs better logs #9813](https://github.com/microsoft/microsoft-ui-xaml/issues/9813)
- [Can't get error output from XamlCompiler.exe #10027](https://github.com/microsoft/microsoft-ui-xaml/issues/10027)
- [MSB3073 error when building Windows app #3545](https://github.com/microsoft/WindowsAppSDK/issues/3545)

## Snapshot Testing Specific

For the snapshot-testing spec (task 6), the following must work before tests can run:

```powershell
# Build the test project
dotnet build tests\FluentPDF.App.Tests -p:Platform=x64

# Run snapshot tests
dotnet test tests\FluentPDF.App.Tests -p:Platform=x64 --filter "FullyQualifiedName~Snapshot"
```

The test project depends on FluentPDF.App building successfully, so resolve any XAML compiler issues first.
